<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Music – Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui, sans-serif; padding:2rem; background:linear-gradient(180deg,#2a1e5c,#fff8e7);}
    .btn{background:#ffc857;color:#412234;padding:.8rem 1.2rem;border-radius:999px;border:none;cursor:pointer}
    .search{margin-top:1rem}
    .tracks{margin-top:1.5rem}
    .track{background:rgba(255,255,255,0.08);padding:1rem;border-radius:8px;margin-bottom:.7rem;color:#fff;display:flex;gap:1rem;align-items:center}
    .track img{width:56px;height:56px;border-radius:6px;object-fit:cover}
  </style>
</head>
<body>
  <h1 style="color:white">My Music</h1>

  <div id="auth-area">
    <button class="btn" id="btn-login">Login with Provider</button>
  </div>

  <div class="search" id="search-area" style="display:none">
    <input id="q" placeholder="Search tracks..." style="padding:.8rem;width:70%;border-radius:8px;border:0;">
    <button class="btn" id="btn-search">Search</button>
    <div class="tracks" id="tracks"></div>
  </div>

  <script>
    document.getElementById('btn-login').addEventListener('click', () => {
      window.location = '/login'; // redirect ke server login -> provider
    });

    async function init() {
      // cek apakah sudah login (panggil /api/me)
      try {
        const r = await fetch('/api/me');
        if (r.ok) {
          document.getElementById('auth-area').style.display = 'none';
          document.getElementById('search-area').style.display = 'block';
        } else {
          document.getElementById('auth-area').style.display = 'block';
        }
      } catch(e){ console.log(e) }
    }

    document.getElementById('btn-search').addEventListener('click', async () => {
      const q = document.getElementById('q').value.trim();
      if (!q) return;
      const resp = await fetch('/api/search?q=' + encodeURIComponent(q));
      const data = await resp.json();
      const container = document.getElementById('tracks');
      container.innerHTML = '';
      const items = data.tracks?.items || [];
      for (const t of items) {
        const el = document.createElement('div');
        el.className = 'track';
        el.innerHTML = `
          <img src="${t.album.images?.[0]?.url || ''}" alt="">
          <div style="flex:1">
            <div style="font-weight:700">${t.name}</div>
            <div style="opacity:.8;font-size:.9rem">${t.artists.map(a=>a.name).join(', ')} · ${t.album.name}</div>
          </div>
          <div><button class="btn" onclick="play('${t.preview_url}')">Play</button></div>
        `;
        container.appendChild(el);
      }
    });

    function play(preview) {
      if (!preview) return alert('No preview available');
      const audio = new Audio(preview);
      audio.play();
    }

    init();
  </script>
</body>
</html>
